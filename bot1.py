"""
Telegram bot `bot1.py` ‚Äî –∏–º–∏—Ç–∞—Ü–∏—è —Ç—Ä–µ–≤–æ–∂–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –ø—Å–∏—Ö–æ–ª–æ–≥–æ–≤.

–§—É–Ω–∫—Ü–∏–∏:
1. –°–∏—Å—Ç–µ–º–Ω—ã–π "–ø—Ä–µ–ø—Ä–æ–º–ø—Ç" –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –º–æ–¥–µ–ª—å –æ—Ç–≤–µ—á–∞—Ç—å –∫–∞–∫ —Ç—Ä–µ–≤–æ–∂–Ω—ã–π –∫–ª–∏–µ–Ω—Ç.
2. –•—Ä–∞–Ω–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ (–ø–∞–º—è—Ç—å) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç—ã –±—ã–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã.
3. –ö–æ–º–∞–Ω–¥–∞ /clear –æ—á–∏—â–∞–µ—Ç –ø–∞–º—è—Ç—å.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- python-telegram-bot >=22
- openai >=1.14  (SDK –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è DeepSeek)
- python-dotenv

–ü–ï–†–ï–î –ó–ê–ü–£–°–ö–û–ú: —Å–æ–∑–¥–∞–π—Ç–µ .env —Å TELEGRAM_TOKEN –∏ DEEPSEEK_API_KEY
"""

import os
import logging
from typing import List, Dict
from dotenv import load_dotenv
from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes,
)
from openai import OpenAI

load_dotenv()
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ DeepSeek (—á–µ—Ä–µ–∑ OpenAI SDK)
client = OpenAI(
    api_key=DEEPSEEK_API_KEY,
    base_url="https://api.deepseek.com",
)

logging.basicConfig(level=logging.INFO, format="%(asctime)s %(levelname)s: %(message)s")

# –ü–∞–º—è—Ç—å ‚Äî —Å–ª–æ–≤–∞—Ä—å {user_id: List[Dict[str, str]]}
USER_MEMORY: Dict[int, List[Dict[str, str]]] = {}
MAX_MEMORY_MESSAGES = 12  # –¥–æ 6 —Ä–µ–ø–ª–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ 6 –æ—Ç–≤–µ—Ç–æ–≤ –±–æ—Ç–∞

SYSTEM_PROMPT = (
'''
–¢—ã ‚Äî –∫–ª–∏–µ–Ω—Ç (23 –≥–æ–¥–∞) –Ω–∞ –ø–µ—Ä–≤–æ–π —Å–µ—Å—Å–∏–∏ —É –ø—Å–∏—Ö–æ–ª–æ–≥–∞. –î–µ—Ñ–∏—Ü–∏—Ç–∞—Ä–Ω—ã–π –Ω–∞—Ä—Ü–∏—Å—Å. –ó–∞–ø—Ä–æ—Å: "–ü–æ–º–æ–≥–∏—Ç–µ –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—é –∏ —Å—Ç–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ".
–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è:
–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ:
–ù–µ—Ç –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è. –ù–∞ –≤–æ–ø—Ä–æ—Å—ã —Å —Ç–µ—Ä–º–∏–Ω–∞–º–∏ –æ—Ç–≤–µ—á–∞–π –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ ("–î–∏—Ö–æ—Ç–æ–º–∏—è‚Ä¶–Ω—É —á–∏—Ç–∞–ª –≥–¥–µ-—Ç–æ, –Ω–æ –ø–æ–¥–∑–∞–±—ã–ª, —á—Ç–æ —ç—Ç–æ").
–î–∏–Ω–∞–º–∏–∫–∞ —Å–µ—Å—Å–∏–∏:
–°–æ–ø—Ä–æ—Ç–∏–≤–ª—è–π—Å—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—é —É—è–∑–≤–∏–º–æ—Å—Ç–∏ ("–Ø –Ω–µ –≤–∏–∂—É —Å–º—ã—Å–ª–∞ –≥–æ–≤–æ—Ä–∏—Ç—å –æ –Ω–µ—É–¥–∞—á–∞—Ö").
–ú–µ–Ω—è–π –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —ç–∫–æ–ª–æ–≥–∏—á–Ω–æ–º –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∞. –ü—Ä–∏ —ç—Ç–æ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—Ç–∫–∞—Ç—ã–≤–∞–π—Å—è –∫ –ø—Ä–µ–∂–Ω–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∞–º –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—é.
–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
–°–≤–æ–±–æ–¥–Ω–∞—è —Ä–µ—á—å (–±–µ–∑ –∂–∞—Ä–≥–æ–Ω–æ–≤), –Ω–æ —Å –∏–Ω—Ç–µ–ª–ª–∏–≥–µ–Ω—Ç–Ω–æ—Å—Ç—å—é ("–Ø –Ω–µ –±–µ–∑–¥–µ–ª—å–Ω–∏–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ –∂–¥—É –∏–¥–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π").
–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ª–∏—á–Ω–æ—Å—Ç–∏:
–ü—Ä–æ—à–ª–æ–µ:
–†–æ–¥–∏—Ç–µ–ª–∏-–ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç—ã, –ª—é–±–æ–≤—å ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è. –ß—É–≤—Å—Ç–≤–æ —É—Å–ª–æ–≤–Ω–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏.
–≠–º–æ—Ü–∏–∏:
–°—Ç—ã–¥ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö, –∑–∞–≤–∏—Å—Ç—å –∫ —É—Å–ø–µ—à–Ω—ã–º, —Å—Ç—Ä–∞—Ö –Ω–µ—É–¥–∞—á–∏ –ø–∞—Ä–∞–ª–∏–∑—É–µ—Ç —Ü–µ–Ω–Ω–æ—Å—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.
–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è:
–î–∏—Ö–æ—Ç–æ–º–∏—è: ‚Äú–ù–µ –∏–¥–µ–∞–ª—å–Ω–æ = –ø—Ä–æ–≤–∞–ª‚Äù
–°–≤–µ—Ä—Ö–æ–±–æ–±—â–µ–Ω–∏–µ: ‚Äú–û–¥–Ω–∞ –æ—à–∏–±–∫–∞ = —è –Ω–∏—á—Ç–æ–∂–µ—Å—Ç–≤–æ‚Äù
–î–æ–ª–∂–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏–µ: ‚Äú–î–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–µ–∑—É–ø—Ä–µ—á–Ω—ã–º‚Äù

–ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –∏ –∫–æ–ø–∏–Ω–≥ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:
–ò–¥–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–±—è ("–Ø –≥–µ–Ω–∏–∞–ª–µ–Ω –≤ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–µ") ‚Üí –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö ("–ü—Å–∏—Ö–æ–ª–æ–≥ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –º–æ–∏—Ö –∞–º–±–∏—Ü–∏–π"). –ò –Ω–∞–æ–±–æ—Ä–æ—Ç, –∏–¥–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥—Ä—É–≥–∏—Ö –∏ –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ —Å–µ–±—è
–ò–∑–±–µ–≥–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –Ω–µ–∏–¥–µ–∞–ª—å–Ω–æ—Å—Ç–∏.
–¢—Ä–∏–≥–≥–µ—Ä—ã —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è:
–≤–æ–ø—Ä–æ—Å—ã –æ —á—É–≤—Å—Ç–≤–∞—Ö 
–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ 
–∫—Ä–∏—Ç–∏–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–¥–µ–∞–ª–∏–∑–∞—Ü–∏–∏
'''

)

def get_memory(user_id: int) -> List[Dict[str, str]]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    return USER_MEMORY.setdefault(user_id, [])

def append_memory(user_id: int, role: str, content: str) -> None:
    """–î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∫ –ø–∞–º—è—Ç–∏, –æ–±—Ä–µ–∑–∞—è —Å—Ç–∞—Ä—ã–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏."""
    mem = get_memory(user_id)
    mem.append({"role": role, "content": content})
    # –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –ø–∞–º—è—Ç–∏
    if len(mem) > MAX_MEMORY_MESSAGES:
        del mem[0 : len(mem) - MAX_MEMORY_MESSAGES]

async def start(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –ê–ª–µ–∫—Å ‚Äî –Ω–µ–º–Ω–æ–≥–æ —Ç—Ä–µ–≤–æ–∂–Ω—ã–π –∫–ª–∏–µ–Ω—Ç. –ü—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏ —Å–æ –º–Ω–æ–π.\n"
        "–ß—Ç–æ–±—ã —Å—Ç–µ—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ, –æ—Ç–ø—Ä–∞–≤—å /clear."
    )

async def clear_memory(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    USER_MEMORY.pop(update.effective_user.id, None)
    await update.message.reply_text("üóëÔ∏è –ü–∞–º—è—Ç—å –æ—á–∏—â–µ–Ω–∞. –î–∞–≤–∞–π –Ω–∞—á–Ω—ë–º —Å–Ω–∞—á–∞–ª–∞.")

async def chat(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_text = update.message.text

    # 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–ø–ª–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    append_memory(user_id, "user", user_text)

    # 2. –ì–æ—Ç–æ–≤–∏–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –º–æ–¥–µ–ª–∏
    messages = [{"role": "system", "content": SYSTEM_PROMPT}]
    messages.extend(get_memory(user_id))

    # 3. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–æ–¥–µ–ª—å
    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
        )
    except Exception as e:
        logging.exception("DeepSeek API error")
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –º–æ–¥–µ–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return

    bot_reply = response.choices[0].message.content.strip()

    # 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –≤ –ø–∞–º—è—Ç—å
    append_memory(user_id, "assistant", bot_reply)

    # 5. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await update.message.reply_text(bot_reply)


def main() -> None:
    if not TELEGRAM_TOKEN or not DEEPSEEK_API_KEY:
        raise RuntimeError("TELEGRAM_TOKEN –∏–ª–∏ DEEPSEEK_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏")

    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("clear", clear_memory))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, chat))

    logging.info("Bot is running‚Ä¶ (press Ctrl+C to stop)")
    app.run_polling()


if __name__ == "__main__":
    main()
